workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "api"
variables:
  EJ_FOLDER_WORK: "/builds/workspace" # a directory with all files generated by Junie
  ENV_FILE: "/builds/workspace/env_vars.env"
  GIT_DEPTH: 1
before_script:
  - export GIT_REMOTE_URL="${CI_SERVER_PROTOCOL}://oauth2:${APP_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
  - export DOT_MATTERHORN="$EJ_FOLDER_WORK/.matterhorn"
  - |
    if [ -n "$ISSUE_ID" ]; then
      export JUNIE_BRANCH="junie-issue-$ISSUE_ID-$CI_PIPELINE_ID"
      export JUNIE_COMMIT_MSG="[Junie] Automated changes for issue #$ISSUE_ID"
    else
      export SHORT_REF=$(echo $CI_COMMIT_REF_NAME | cut -c1-8)
      export JUNIE_BRANCH="junie-$SHORT_REF"
      export JUNIE_COMMIT_MSG="[Junie] Automated changes ($SHORT_REF)"
    fi
  - apt-get update
  - apt-get install -y git jq || true
  - mkdir -p $EJ_FOLDER_WORK
  - npm install -g @jetbrains/junie-cli
  - printenv  > $ENV_FILE
after_script:
  - |
    while IFS='=' read -r key value; do
      [[ -z "$key" ]] && continue
      if [[ "$key" =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]]; then
        if [ -z "${!key+x}" ]; then
          export "$key"="$value" || continue
        fi
      fi
    done < "$ENV_FILE"
  - rm $ENV_FILE
  - export JUNIE_SUMMARY="$(jq -r '.content.output' "$DOT_MATTERHORN"/issue_md/issue.issue)" || true
  - export JUNIE_SUMMARY_ESCAPED=$(printf "%s" "$JUNIE_SUMMARY" | jq -R -c . | sed 's/^"\(.*\)"$/\1/') || true
  - |
    EJ_RUNNER_INFO_DATA=$(echo "$EJ_RUNNER_INFO" \
      | jq --arg JUNIE_BRANCH "$JUNIE_BRANCH" --arg JUNIE_SUMMARY_ESCAPED "$JUNIE_SUMMARY_ESCAPED" --arg CI_JOB_STATUS "$CI_JOB_STATUS" --arg CI_PIPELINE_URL "$CI_PIPELINE_URL" '.sourceBranch = $JUNIE_BRANCH | .junieResult = $JUNIE_SUMMARY_ESCAPED | .jobStatus = $CI_JOB_STATUS | .jobUrl = $CI_PIPELINE_URL')
    
    echo "EJ_RUNNER_INFO:"
    echo "$EJ_RUNNER_INFO"
    echo "EJ_RUNNER_INFO_DATA:"
    echo "$EJ_RUNNER_INFO_DATA"
    curl -v -L --request POST "${APP_API_URL}/runner/results" \
      --header "X-Gitlab-Token: $APP_TOKEN" \
      --header "Content-Type: application/json" \
      --data "$EJ_RUNNER_INFO_DATA"
  - mkdir -p "$CI_PROJECT_DIR/logs"
  - cp -r "$DOT_MATTERHORN"/* "$CI_PROJECT_DIR/logs/"
stages:
  - build
run_junie:
  stage: build
  image: node:24-trixie
  script:
    - echo "===== [STAGE] Setup & Run Junie ====="
    - echo "template - $MR_DESCRIPTION"
    - junie --cache-dir="$EJ_FOLDER_WORK" --output-format="json" --auth $JUNIE_API_KEY "$EJ_TASK"
    - git status
    - echo "===== [STAGE] Save Junie Summary ====="
    - |
      if ! ls $DOT_MATTERHORN/issue_md.* 1> /dev/null 2>&1; then
        echo "No $DOT_MATTERHORN/issue_md.* file found!" >&2
        ls -la $DOT_MATTERHORN
        exit 1
      fi
    - echo "===== [STAGE] Commit and Push Changes ====="
    - |
      if git lfs env > /dev/null 2>&1; then
        chown -R $(whoami) .git || true
        chmod -R u+w .git/hooks || true
        git lfs update --force
      fi
    - git config --global user.name "Junie"
    - git config --global user.email "Junie@jetbrains.com"
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
    - git checkout -b "$JUNIE_BRANCH" || git checkout "$JUNIE_BRANCH"
    - git status
    - git add -A :!$ENV_FILE ':!*.orig' ':!*.rej' ':!*.class'
    - |
      if ! git diff --cached --quiet; then
        git commit -m "$JUNIE_COMMIT_MSG"
        git remote set-url origin "$GIT_REMOTE_URL"
        git push --set-upstream origin "$JUNIE_BRANCH"
      else
        echo "No changes to commit."
      fi
  artifacts:
    name: "junie-logs"
    paths:
      - logs/**
    expire_in: 1 day
    when: always
